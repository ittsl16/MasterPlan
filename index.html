<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master plan </title>
   
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" 
          integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" 
          crossorigin="anonymous" referrerpolicy="no-referrer">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Script de Supabase con atributos crossorigin e integrity -->
 <!-- Script de Supabase sin integrity -->
<script 
    src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"
    crossorigin="anonymous">
</script>
    
    <style>
        :root {
            --rojo-principal: #CF002E;
            --amarillo-principal: #FDD000;
            --degradado-amarillo: linear-gradient(to bottom, #FFFFFF, #FDD000);
            --gris-claro: #f5f5f5;
            --gris-medio: #e0e0e0;
            --gris-oscuro: #333333;
            --verde: #4CAF50;
            --rojo: #f44336;
            --amarillo: #ff9800;
            --azul: #2196F3;
            --morado: #9C27B0;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--gris-claro);
            color: var(--gris-oscuro);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* Header */
        header {
            background: var(--degradado-amarillo);
            padding: 15px 0;
            border-bottom: 3px solid var(--rojo-principal);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo i {
            color: var(--rojo-principal);
            font-size: 2.5rem;
        }
        
        .logo h1 {
            font-size: 1.8rem;
            color: var(--rojo-principal);
        }
        
        /* Bot√≥n de administrador */
        .admin-btn {
            background-color: var(--rojo-principal);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .admin-btn:hover {
            background-color: #a00024;
        }
        
        /* Controles de b√∫squeda y filtro */
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 25px 0;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }
        
        .search-box {
            flex: 1;
            min-width: 300px;
            position: relative;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 15px 12px 45px;
            border: 1px solid var(--gris-medio);
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gris-oscuro);
        }
        
        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .filter-btn {
            padding: 10px 20px;
            border: 1px solid var(--gris-medio);
            background-color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .filter-btn:hover {
            background-color: var(--gris-claro);
        }
        
        .filter-btn.active {
            background-color: var(--rojo-principal);
            color: white;
            border-color: var(--rojo-principal);
        }
        
        /* Contenedor scrollable para tablas */
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            margin-bottom: 30px;
            background-color: white;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }
        
        .table-container table {
            min-width: 1400px;
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: var(--degradado-amarillo);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: var(--rojo-principal);
            border-bottom: 2px solid var(--rojo-principal);
            white-space: nowrap;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid var(--gris-medio);
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        tr:hover {
            background-color: rgba(207, 0, 46, 0.05);
        }
        
        /* Indicadores de estatus */
        .status {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .status.cerrado {
            background-color: var(--verde);
            color: white;
        }
        
        .status.atrasado {
            background-color: var(--rojo);
            color: white;
        }
        
        .status.en_proceso {
            background-color: var(--amarillo);
            color: var(--gris-oscuro);
        }
        
        .status.tbd {
            background-color: var(--azul);
            color: white;
        }
        
        /* Celda de observaci√≥n */
        .observacion-cell {
            max-width: 200px;
            max-height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .observacion-cell.expanded {
            white-space: normal;
            max-width: 400px;
            max-height: none;
            overflow: visible;
            background-color: rgba(253, 208, 0, 0.1);
            padding: 10px;
            border-radius: 5px;
            border-left: 3px solid var(--amarillo-principal);
        }
        
        /* Botones de acci√≥n */
        .action-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
            margin: 2px;
            font-size: 0.85rem;
            white-space: nowrap;
        }
        
        .upload-btn {
            background-color: var(--azul);
            color: white;
        }
        
        .upload-btn:hover {
            background-color: #0b7dda;
        }
        
        .view-btn {
            background-color: var(--verde);
            color: white;
        }
        
        .view-btn:hover {
            background-color: #3d8b40;
        }
        
        .download-btn {
            background-color: var(--morado);
            color: white;
        }
        
        .download-btn:hover {
            background-color: #7b1fa2;
        }
        
        .delete-btn {
            background-color: var(--rojo);
            color: white;
        }
        
        .delete-btn:hover {
            background-color: #d32f2f;
        }
        
        .edit-obs-btn {
            background-color: var(--amarillo);
            color: var(--gris-oscuro);
        }
        
        .edit-obs-btn:hover {
            background-color: #f57c00;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 90%;
            overflow-y: auto;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        .modal-header {
            padding: 20px;
            background: var(--degradado-amarillo);
            border-bottom: 1px solid var(--gris-medio);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            color: var(--rojo-principal);
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--rojo-principal);
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--gris-oscuro);
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--gris-medio);
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .submit-btn {
            background-color: var(--rojo-principal);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
            width: 100%;
            transition: background-color 0.3s;
        }
        
        .submit-btn:hover {
            background-color: #a00024;
        }
        
        /* Panel de administraci√≥n */
        .admin-panel {
            display: none;
        }
        
        .admin-header {
            background-color: var(--rojo-principal);
            color: white;
            padding: 15px 0;
        }
        
        .admin-header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logout-btn {
            background-color: white;
            color: var(--rojo-principal);
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .logout-btn:hover {
            background-color: var(--gris-claro);
        }
        
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }
        
        .stat-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            text-align: center;
        }
        
        .stat-card h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }
        
        .stat-card p {
            font-size: 2.5rem;
            font-weight: bold;
        }
        
        .card-atrasados {
            border-top: 5px solid var(--rojo);
        }
        
        .card-en-proceso {
            border-top: 5px solid var(--amarillo);
        }
        
        .card-cerrados {
            border-top: 5px solid var(--verde);
        }
        
        /* Gr√°fica peque√±a */
        .small-chart-container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin: 30px auto;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            max-width: 500px;
        }
        
        .chart-title {
            text-align: center;
            margin-bottom: 15px;
            color: var(--rojo-principal);
            font-size: 1.2rem;
        }
        
        /* Filtros de fechas para admin */
        .date-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
            margin-bottom: 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }
        
        .date-filters .form-group {
            margin-bottom: 0;
            flex: 1;
            min-width: 200px;
        }
        
        .date-filters label {
            font-size: 0.9rem;
            margin-bottom: 5px;
            color: var(--gris-oscuro);
        }
        
        /* Contenedor de acciones del admin */
        .admin-actions-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 15px;
        }
        
        .admin-filter-section {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        
        .add-btn {
            background-color: var(--verde);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }
        
        .add-btn:hover {
            background-color: #3d8b40;
        }
        
        /* Modal para observaciones */
        .observacion-modal .modal-content {
            max-width: 600px;
        }
        
        .observacion-text {
            background-color: var(--gris-claro);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid var(--amarillo-principal);
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .table-container {
                margin-left: -20px;
                margin-right: -20px;
                border-radius: 0;
            }
            
            .table-container table {
                min-width: 1200px;
            }
        }
        
        @media (max-width: 992px) {
            .controls {
                flex-direction: column;
            }
            
            .search-box {
                min-width: 100%;
            }
            
            .admin-actions-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .date-filters {
                flex-direction: column;
                align-items: stretch;
            }
            
            .date-filters .form-group {
                min-width: 100%;
            }
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .admin-header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .stats-cards {
                grid-template-columns: 1fr;
            }
            
            .filter-buttons {
                justify-content: center;
            }
            
            .action-btn {
                padding: 6px 8px;
                font-size: 0.8rem;
            }
            
            th, td {
                padding: 10px 8px;
            }
        }
        
        /* Estilos para mensajes de carga y error */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(207, 0, 46, 0.3);
            border-radius: 50%;
            border-top-color: var(--rojo-principal);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error-message {
            background-color: #ffebee;
            border: 1px solid #f44336;
            color: #c62828;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            text-align: center;
        }
        
        /* Bot√≥n de reintento */
        .retry-btn {
            background-color: var(--amarillo-principal);
            color: var(--gris-oscuro);
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .retry-btn:hover {
            background-color: #e6b800;
        }
        
.card-total {
    border-top: 5px solid var(--rojo-principal);
}

/* Si quieres colores espec√≠ficos para cada tarjeta, puedes agregar: */
.stat-card.card-total p {
    color: var(--rojo-principal);
}

.stat-card.card-atrasados p {
    color: var(--rojo);
}

.stat-card.card-en-proceso p {
    color: var(--amarillo);
}

.stat-card.card-cerrados p {
    color: var(--verde);
}

.stat-card.card-tbd p {
    color: var(--azul);
}
/* ========== ESTILOS PARA EL SISTEMA DE CORREOS ========== */
.alert-select {
    width: 100%;
    padding: 12px;
    border: 1px solid var(--gris-medio);
    border-radius: 5px;
    font-size: 1rem;
    background-color: white;
    cursor: pointer;
}

.alert-select:focus {
    outline: none;
    border-color: var(--rojo-principal);
    box-shadow: 0 0 0 2px rgba(207, 0, 46, 0.1);
}

.recipient-item {
    display: flex;
    align-items: center;
    padding: 10px;
    margin-bottom: 5px;
    background: white;
    border-radius: 5px;
    border: 1px solid var(--gris-medio);
    transition: all 0.2s;
    cursor: pointer;
}

.recipient-item:hover {
    background: rgba(253, 208, 0, 0.1);
    border-color: var(--amarillo-principal);
}

.recipient-item.selected {
    background: rgba(207, 0, 46, 0.05);
    border-color: var(--rojo-principal);
}

.recipient-checkbox {
    margin-right: 10px;
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.recipient-info {
    flex: 1;
}

.recipient-name {
    font-weight: 600;
    font-size: 0.95rem;
    color: var(--gris-oscuro);
}

.recipient-email {
    font-size: 0.85rem;
    color: var(--gris-oscuro);
    opacity: 0.7;
}

/* Vista previa del correo */
.email-preview-table {
    width: 100%;
    border-collapse: collapse;
    margin: 10px 0;
    font-size: 14px;
}

.email-preview-table th {
    background: var(--gris-claro);
    padding: 8px;
    text-align: left;
    border: 1px solid var(--gris-medio);
    font-weight: 600;
}

.email-preview-table td {
    padding: 8px;
    border: 1px solid var(--gris-medio);
}

.email-badge {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: bold;
    margin: 2px;
}

.badge-red {
    background: var(--rojo);
    color: white;
}

.badge-orange {
    background: var(--amarillo);
    color: var(--gris-oscuro);
}

.badge-green {
    background: var(--verde);
    color: white;
}

/* Responsive */
@media (max-width: 768px) {
    #email-stats {
        grid-template-columns: 1fr;
    }
    
    .recipient-item {
        padding: 8px;
    }
}

/* Modal para ver texto completo */
.full-text-modal .modal-content {
    max-width: 800px;
}

.text-content {
    max-height: 400px;
    overflow-y: auto;
    padding: 15px;
    background-color: #f9f9f9;
    border-radius: 5px;
    border: 1px solid #e0e0e0;
    white-space: pre-wrap;
    word-wrap: break-word;
    line-height: 1.5;
}

.text-section {
    margin-bottom: 20px;
}

.text-section h4 {
    color: var(--rojo-principal);
    margin-bottom: 10px;
    padding-bottom: 5px;
    border-bottom: 2px solid var(--amarillo-principal);
}

/* Bot√≥n para ver texto completo en las celdas */
.view-text-btn {
    background: none;
    border: none;
    color: var(--azul);
    cursor: pointer;
    padding: 5px;
    font-size: 0.8rem;
    display: inline-flex;
    align-items: center;
    gap: 3px;
}

.view-text-btn:hover {
    text-decoration: underline;
}
    </style>
</head>
<body>
    <!-- Pantalla principal (p√∫blica) -->
    <div id="public-panel">
        <header>
            <div class="container header-content">
                <div class="logo">
                    <i class="fas fa-clipboard-check"></i>
                    <h1>Master plan </h1>
                </div>
                <button id="admin-access-btn" class="admin-btn">
                    <i class="fas fa-user-shield"></i> Administrador
                </button>
            </div>
        </header>
        
        <main class="container">
            <div class="controls">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="search-input" placeholder="Buscar por ID, proceso, √°rea, responsable...">
                </div>
                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="all">Todos</button>
                    <button class="filter-btn" data-filter="atrasado">Atrasados</button>
                    <button class="filter-btn" data-filter="en_proceso">En Proceso</button>
                    <button class="filter-btn" data-filter="cerrado">Cerrados</button>
                    <button class="filter-btn" data-filter="tbd">TBD</button>
                </div>
            </div>
            
            <div class="table-container">
                <table id="events-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Proceso</th>
                            <th>√Årea</th>
                            <th>Criticidad</th>
                            <th>Descripci√≥n</th>
                            <th>Plan de acci√≥n</th>
                            <th>Responsable</th>
                            <th>Fecha compromiso</th>
                            <th>√öltima actualizaci√≥n</th>
                            <th>Observaci√≥n</th>
                            <th>Estatus</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="events-body">
                        <!-- Los eventos se cargar√°n aqu√≠ din√°micamente -->
                        <tr id="loading-row">
                            <td colspan="12" style="text-align: center; padding: 30px;">
                                <div class="loading" style="margin: 0 auto 10px;"></div>
                                <p>Cargando eventos...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>
    
    <!-- Panel de administraci√≥n (privado) -->
    <div id="admin-panel" class="admin-panel">
        <div class="admin-header">
            <div class="container admin-header-content">
                <div class="logo">
                    <i class="fas fa-user-shield"></i>
                    <h1>Panel de Administraci√≥n</h1>
                </div>
                <button id="logout-btn" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
                </button>
            </div>
        </div>
        
        <main class="container">
            <div class="stats-cards">
    <!-- Tarjeta de Total con icono -->
    <div class="stat-card card-total" style="border-top: 5px solid var(--rojo-principal);">
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <h3><i class="fas fa-clipboard-list" style="margin-right: 10px;"></i>Total eventos</h3>
            <span style="font-size: 1.2rem; color: var(--gris-oscuro); opacity: 0.7;">100%</span>
        </div>
        <p id="total-count" style="font-size: 2.8rem;">0</p>
    </div>
    
    <!-- Tarjeta de Atrasados con icono -->
    <div class="stat-card card-atrasados">
        <h3><i class="fas fa-exclamation-triangle" style="margin-right: 10px;"></i>Atrasados</h3>
        <p id="atrasados-count">0</p>
        <small id="atrasados-percent" style="color: var(--gris-oscuro); opacity: 0.8;">0% del total</small>
    </div>
    
    <!-- Tarjeta de En Proceso con icono -->
    <div class="stat-card card-en-proceso">
        <h3><i class="fas fa-spinner" style="margin-right: 10px;"></i>En Proceso</h3>
        <p id="en-proceso-count">0</p>
        <small id="en-proceso-percent" style="color: var(--gris-oscuro); opacity: 0.8;">0% del total</small>
    </div>
    
    <!-- Tarjeta de Cerrados con icono -->
    <div class="stat-card card-cerrados">
        <h3><i class="fas fa-check-circle" style="margin-right: 10px;"></i>Cerrados</h3>
        <p id="cerrados-count">0</p>
        <small id="cerrados-percent" style="color: var(--gris-oscuro); opacity: 0.8;">0% del total</small>
    </div>
    
    <!-- Tarjeta de TBD con icono -->
    <div class="stat-card card-tbd" style="border-top: 5px solid var(--azul);">
        <h3><i class="fas fa-question-circle" style="margin-right: 10px;"></i>TBD</h3>
        <p id="tbd-count">0</p>
        <small id="tbd-percent" style="color: var(--gris-oscuro); opacity: 0.8;">0% del total</small>
    </div>
</div>
            
            <div class="date-filters">
                <!-- Reemplazar completamente la secci√≥n date-filters con esto: -->
<div class="controls" style="margin: 20px 0;">
    <div class="search-box">
        <i class="fas fa-search"></i>
        <input type="text" id="admin-search-input" placeholder="Buscar por ID, proceso, √°rea, responsable...">
    </div>
    <div class="filter-buttons">
        <button class="filter-btn active" data-filter="all">Todos</button>
        <button class="filter-btn" data-filter="atrasado">Atrasados</button>
        <button class="filter-btn" data-filter="en_proceso">En Proceso</button>
        <button class="filter-btn" data-filter="cerrado">Cerrados</button>
        <button class="filter-btn" data-filter="tbd">TBD</button>
    </div>
</div>

<div class="admin-actions-container">
    <button id="add-event-btn" class="add-btn">
        <i class="fas fa-plus-circle"></i> Agregar nuevo evento
    </button>
    
   
    <button id="send-email-alerts-btn" class="add-btn" style="background-color: #9C27B0;">
        <i class="fas fa-paper-plane"></i> Enviar alertas por correo
    </button>
</div>
            </div>
            
            
            <div class="table-container">
                <table id="admin-events-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Proceso</th>
                            <th>√Årea</th>
                            <th>Criticidad</th>
                            <th>Descripci√≥n</th>
                            <th>Plan de acci√≥n</th>
                            <th>Responsable</th>
                            <th>Fecha compromiso</th>
                            <th>√öltima actualizaci√≥n</th>
                            <th>Observaci√≥n</th>
                            <th>Estatus</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="admin-events-body">
                        <!-- Los eventos se cargar√°n aqu√≠ din√°micamente -->
                        <tr id="admin-loading-row">
                            <td colspan="12" style="text-align: center; padding: 30px;">
                                <div class="loading" style="margin: 0 auto 10px;"></div>
                                <p>Cargando eventos...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="small-chart-container">
                <h3 class="chart-title">Distribuci√≥n de eventos por estatus</h3>
                <canvas id="status-chart"></canvas>
            </div>
        </main>
    </div>
    
    <!-- Modal de login -->
    <div id="login-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Acceso de Administrador</h2>
                <button class="close-modal" id="close-login-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="admin-password">Contrase√±a:</label>
                    <input type="password" id="admin-password" placeholder="Ingrese la contrase√±a">
                </div>
                <button id="login-submit" class="submit-btn">Ingresar</button>
                <p id="login-error" style="color: var(--rojo); margin-top: 15px; display: none;">Contrase√±a incorrecta. Intente nuevamente.</p>
            </div>
        </div>
    </div>
    
    <!-- Modal para subir evidencia -->
    <div id="upload-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Subir evidencia</h2>
                <button class="close-modal" id="close-upload-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="event-id">ID del evento:</label>
                    <input type="text" id="event-id" readonly>
                </div>
                <div class="form-group">
                    <label for="evidence-file">Seleccionar archivo PDF:</label>
                    <input type="file" id="evidence-file" accept=".pdf">
                </div>
                <div id="upload-status" style="display: none; text-align: center; margin: 10px 0;">
                    <div class="loading" style="display: inline-block;"></div>
                    <p style="margin-top: 5px;">Subiendo archivo...</p>
                </div>
                <button id="upload-submit" class="submit-btn">Subir evidencia</button>
                <p id="upload-error" style="color: var(--rojo); margin-top: 15px; display: none;"></p>
                <p id="upload-success" style="color: var(--verde); margin-top: 15px; display: none;">¬°Archivo subido exitosamente!</p>
            </div>
        </div>
    </div>
    
    <!-- Modal para agregar/editar evento -->
    <div id="event-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="event-modal-title">Nuevo evento</h2>
                <button class="close-modal" id="close-event-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="event-form">
                    <div class="form-group">
                        <label for="proceso">Proceso:</label>
                        <input type="text" id="proceso" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="area">√Årea:</label>
                        <select id="area" required>
                            <option value="">Seleccionar √°rea</option>
                            <option value="INVENTARIOS">INVENTARIOS</option>
                            <option value="OPERACIONES">OPERACIONES</option>
                            <option value="OMS">OMS</option>
                            <option value="MANTENIMIENTO">MANTENIMIENTO</option>
                            <option value="SISTEMAS">SISTEMAS</option>
                            <option value="CRYD">CRYD</option>
                            <option value="PFCT OPS">PFCT OPS</option>
                            <option value="PFCT QA">PFCT QA</option>
                            <option value="IMPORTADOS QA">IMPORTADOS QA</option>
                            <option value="SMO QA">SMO QA</option>
                            <option value="CUSTOMIZADO">CUSTOMIZADO</option>
                            <option value="TRANSPORTE">TRANSPORTE</option>
                            <option value="PATIOS">PATIOS</option>
                            <option value="HS&E">HS&E</option>
                            <option value="RH">RH</option>
                            <option value="CI">CI</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="criticidad">Criticidad:</label>
                        <select id="criticidad" required>
                            <option value="">Seleccionar criticidad</option>
                            <option value="Mayor">Mayor</option>
                            <option value="Menor">Menor</option>
                            <option value="Critica">Cr√≠tica</option>
                            <option value="Observaci√≥n">Observaci√≥n</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="descripcion">Descripci√≥n de evento:</label>
                        <textarea id="descripcion" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="plan_accion">Plan de acci√≥n:</label>
                        <textarea id="plan_accion" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="responsable">Responsable:</label>
                        <select id="responsable" required>
                            <option value="">Seleccionar responsable</option>
                            <option value="German Fueyo Arce">German Fueyo Arce</option>
                            <option value="Ignacio Cortez Acu√±a">Ignacio Cortez Acu√±a</option>
                            <option value="Ricardo G. Abreo Ordo√±ez">Ricardo G. Abreo Ordo√±ez</option>
                            <option value="Cinthya Arroyo Bravo">Cinthya Arroyo Bravo</option>
                            <option value="Edgar Olivo G√≥mez">Edgar Olivo G√≥mez</option>
                            <option value="Rogelio Garcia Soto">Rogelio Garcia Soto</option>
                            <option value="F√©lix Montoya Villafa√±a">F√©lix Montoya Villafa√±a</option>
                            <option value="Maria Luisa Reyes Balderas">Maria Luisa Reyes Balderas</option>
                            <option value="Jorge Palacios Gonzalez">Jorge Palacios Gonzalez</option>
                            <option value="Evelin Hinojosa Fabila">Evelin Hinojosa Fabila</option>
                            <option value="Claudia Giovani Guerrero Velazquez">Claudia Giovani Guerrero Velazquez</option>
                            <option value="Veronica Jazmin Garcia Garcia">Veronica Jazmin Garcia Garcia</option>

                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="fecha_compromiso">Fecha compromiso:</label>
                        <input type="date" id="fecha_compromiso" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="estatus">Estatus:</label>
                        <select id="estatus" required>
                            <option value="en_proceso">En Proceso</option>
                            <option value="atrasado">Atrasado</option>
                            <option value="cerrado">Cerrado</option>
                            <option value="tbd">TBD</option>
                        </select>
                    </div>
                    
                    <input type="hidden" id="event-id-edit">
                    <div id="save-status" style="display: none; text-align: center; margin: 10px 0;">
                        <div class="loading" style="display: inline-block;"></div>
                        <p style="margin-top: 5px;">Guardando evento...</p>
                    </div>
                    <button type="submit" class="submit-btn" id="save-event-btn">Guardar evento</button>
                </form>
            </div>
        </div>
    </div>
    <!-- ========== MODAL PARA ENVIAR CORREOS AUTOM√ÅTICOS ========== -->
<div id="email-alerts-modal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h2><i class="fas fa-mail-bulk"></i> Enviar alertas por correo</h2>
            <button class="close-modal" id="close-email-alerts-modal">&times;</button>
        </div>
        
        <div class="modal-body">
            <!-- Paso 1: Selecci√≥n de tipo de alerta -->
            <div class="form-group">
                <label for="email-alert-type">
                    <i class="fas fa-filter"></i> Tipo de Alerta:
                </label>
                <select id="email-alert-type" class="alert-select">
    <option value="atrasados">üî¥ Reporte de eventos atrasados</option>
    <option value="proximos">üü° Reporte de eventos pr√≥ximos (‚â§ 3 d√≠as)</option>
    <option value="ambos" selected>‚ö†Ô∏è Reporte combinado (atrasados + pr√≥ximos)</option>
    <option value="todos">üìã Reporte completo de eventos activos</option>
</select>
            </div>
            
            <!--  Selecci√≥n de destinatarios -->
            <div class="form-group">
                <label>
                    <i class="fas fa-users"></i> Destinatarios:
                </label>
                
                <div style="margin-top: 10px; background: #f8f9fa; padding: 15px; border-radius: 5px;">
                    <!-- Botones r√°pidos -->
                    <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
                        <button type="button" id="select-all-recipients" class="filter-btn" style="background-color: #4CAF50; color: white;">
                            <i class="fas fa-check-double"></i> Seleccionar Todos
                        </button>
                        <button type="button" id="deselect-all-recipients" class="filter-btn" style="background-color: #f44336; color: white;">
                            <i class="fas fa-times"></i> Deseleccionar Todos
                        </button>
                       
                    </div>
                    
                    <!-- Lista de checkboxes -->
                    <div id="recipients-list-container" style="max-height: 250px; overflow-y: auto; padding: 15px; background: white; border-radius: 5px; border: 1px solid #e0e0e0;">
                        <div id="recipients-loading" style="text-align: center; padding: 20px;">
                            <div class="loading" style="margin: 0 auto 10px;"></div>
                            <p>Cargando destinatarios...</p>
                        </div>
                    </div>
                    
                    <div id="selected-count" style="margin-top: 10px; font-size: 14px; color: #666;">
                        <i class="fas fa-user-check"></i> <span id="selected-count-number">0</span> destinatarios seleccionados
                    </div>
                </div>
            </div>
            
            <!--  Vista previa del correo -->
            <div class="form-group">
                <label>
                    <i class="fas fa-eye"></i> Vista Previa del Correo:
                </label>
                
                <div style="margin-top: 10px; background: white; border: 1px solid #e0e0e0; border-radius: 5px; padding: 15px; max-height: 300px; overflow-y: auto;">
                    <div id="email-preview-content">
                        <p style="text-align: center; color: #666; font-style: italic;">
                            Seleccione el tipo de alerta para ver la vista previa...
                        </p>
                    </div>
                </div>
                
                <div id="email-stats" style="margin-top: 15px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                    <div style="text-align: center; padding: 10px; background: #fff3f3; border-radius: 5px; border-left: 4px solid #CF002E;">
                        <div style="font-size: 20px; font-weight: bold; color: #CF002E;" id="stats-atrasados">0</div>
                        <div style="font-size: 12px; color: #666;">Eventos atrasados</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: #fff9e6; border-radius: 5px; border-left: 4px solid #FDD000;">
                        <div style="font-size: 20px; font-weight: bold; color: #FF9800;" id="stats-proximos">0</div>
                        <div style="font-size: 12px; color: #666;">Eventos pr√≥ximos</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: #f0f0f0; border-radius: 5px; border-left: 4px solid #9C27B0;">
                        <div style="font-size: 20px; font-weight: bold; color: #9C27B0;" id="stats-destinatarios">0</div>
                        <div style="font-size: 12px; color: #666;">Destinatarios</div>
                    </div>
                </div>
            </div>
            
            
            <!-- Botones de acci√≥n -->
            <div style="display: flex; gap: 10px; margin-top: 25px;">
                <button type="button" id="update-preview-btn" class="submit-btn" style="background-color: #FF9800; flex: 1;">
                    <i class="fas fa-sync-alt"></i> Actualizar Vista Previa
                </button>
                <button type="button" id="send-email-now-btn" class="submit-btn" style="flex: 2;">
                    <i class="fas fa-paper-plane"></i> Enviar Correo Ahora
                </button>
            </div>
            
            <!-- Estado del env√≠o -->
            <div id="email-send-status" style="display: none; text-align: center; margin-top: 20px; padding: 15px; border-radius: 5px;"></div>
           
        </div>
    </div>
</div>
<!-- ========== FIN MODAL CORREOS ========== -->
    <!-- Modal para agregar/editar observaci√≥n -->
    <div id="observacion-modal" class="modal observacion-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="observacion-modal-title">Observaci√≥n</h2>
                <button class="close-modal" id="close-observacion-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="event-id-observacion">ID del evento:</label>
                    <input type="text" id="event-id-observacion" readonly>
                </div>
                <div class="form-group">
                    <label for="proceso-observacion">Proceso:</label>
                    <input type="text" id="proceso-observacion" readonly>
                </div>
                <div class="form-group">
                    <label for="observacion-text">Observaci√≥n:</label>
                    <textarea id="observacion-text" rows="4" placeholder="Ingrese una observaci√≥n para este evento..."></textarea>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="eliminar-evidencia"> Eliminar evidencia actual (El usuario deber√° volver a subir el archivo)
                    </label>
                </div>
                <div id="observacion-status" style="display: none; text-align: center; margin: 10px 0;">
                    <div class="loading" style="display: inline-block;"></div>
                    <p style="margin-top: 5px;">Guardando...</p>
                </div>
                <button id="save-observacion-btn" class="submit-btn">Guardar Observaci√≥n</button>
            </div>
        </div>
    </div>
    <!-- Modal para ver texto completo -->
<div id="text-modal" class="modal full-text-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="text-modal-title">Detalles completos</h2>
            <button class="close-modal" id="close-text-modal">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>ID del evento:</label>
                <input type="text" id="text-event-id" readonly>
            </div>
            
            <div class="form-group">
                <label>Proceso:</label>
                <input type="text" id="text-proceso" readonly>
            </div>
            
            <div class="text-section">
                <h4><i class="fas fa-align-left"></i> Descripci√≥n del evento:</h4>
                <div id="text-descripcion" class="text-content"></div>
            </div>
            
            <div class="text-section">
                <h4><i class="fas fa-tasks"></i> Plan de Acci√≥n:</h4>
                <div id="text-plan-accion" class="text-content"></div>
            </div>
            
            <div class="text-section">
                <h4><i class="fas fa-comment"></i> Observaciones:</h4>
                <div id="text-observacion" class="text-content"></div>
            </div>
            
            
        </div>
    </div>
</div>
<script>
    // ========== CONFIGURACI√ìN ========= 
    console.log('=== INICIANDO SISTEMA DE GESTI√ìN DE CALIDAD ===');
    
    // Variables globales
    let events = [];
    let currentFilter = 'all';
    let isAdmin = false;
    let chart = null;
    const ADMIN_PASSWORD = '&U6%Ux';
    let supabaseInitialized = false;
    let supabaseClient = null;
    let recipientsList = [];
    let emailHTMLContent = ''; // Variable global para almacenar HTML del correo
    
    // Configuraci√≥n de Supabase
    const SUPABASE_URL = 'https://osmevrtfbxuiinjptrvz.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9zbWV2cnRmYnh1aWluanB0cnZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0MTIzMTIsImV4cCI6MjA4Mzk4ODMxMn0.oA1leZOpTP4LGXE_ZCVCvQjtlfoWACtmbdkJ8vCwMD0';

    // ========== MANEJO DE ERRORES GLOBALES ==========
    window.addEventListener('error', function(event) {
        console.error('Error global:', event.error);
        
        
        if (event.error && event.error.message && event.error.message.includes('Supabase')) {
            showError('Error de conexi√≥n con la base de datos. Por favor, recarga la p√°gina o intenta m√°s tarde.');
        }
    });

    window.addEventListener('unhandledrejection', function(event) {
        console.error('Promesa rechazada no manejada:', event.reason);
        
        
        if (event.reason && event.reason.message && event.reason.message.includes('Supabase')) {
            showError('Error de conexi√≥n con la base de datos. Por favor, recarga la p√°gina o intenta m√°s tarde.');
        }
    });

    // ========== INICIALIZACI√ìN ==========
    document.addEventListener('DOMContentLoaded', async function() {
        console.log('DOM cargado - Inicializando aplicaci√≥n');
        
        try {
            
            console.log('Inicializando Supabase...');
            const supabaseSuccess = await initSupabase();
            
            if (!supabaseSuccess) {
                showError('No se pudo conectar con la base de datos. La aplicaci√≥n funcionar√° en modo local.');
                events = [];
                displayEvents('events-body', events);
                
                //  bot√≥n de reintento
                const loadingRow = document.getElementById('loading-row');
                if (loadingRow) {
                    loadingRow.innerHTML = `
                        <td colspan="12" style="text-align: center; padding: 30px;">
                            <div style="color: var(--rojo); margin-bottom: 10px;">
                                <i class="fas fa-exclamation-triangle"></i> Error de conexi√≥n
                            </div>
                            <p>No se pudo conectar con la base de datos.</p>
                            <button class="retry-btn" onclick="retryConnection()">
                                <i class="fas fa-redo"></i> Reintentar conexi√≥n
                            </button>
                        </td>
                    `;
                }
            } else {
                console.log('Supabase inicializado correctamente');
            }
            
            //  bot√≥n administrador
            const adminBtn = document.getElementById('admin-access-btn');
            const loginModal = document.getElementById('login-modal');
            
            if (adminBtn && loginModal) {
                console.log('Configurando bot√≥n administrador...');
                
                adminBtn.onclick = function() {
                    console.log('Bot√≥n Administrador CLICKEADO');
                    loginModal.style.display = 'flex';
                    document.getElementById('admin-password')?.focus();
                };
                
                console.log('Bot√≥n administrador configurado correctamente');
            } else {
                console.error('ERROR: No se encontr√≥ el bot√≥n admin o modal login');
            }
            
            // Inicializar resto de la aplicaci√≥n
            initApplication();
            
            // Cargar datos despu√©s de que todo est√© inicializado
            if (supabaseSuccess) {
                await loadInitialData();
            }
            
        } catch (error) {
            console.error('Error durante la inicializaci√≥n:', error);
            showError('Error al inicializar la aplicaci√≥n: ' + error.message);
        }
    });

    // ========== FUNCI√ìN PARA REINTENTAR CONEXI√ìN ==========
    async function retryConnection() {
        console.log('Reintentando conexi√≥n con Supabase...');
        
        const loadingRow = document.getElementById('loading-row');
        if (loadingRow) {
            loadingRow.innerHTML = `
                <td colspan="12" style="text-align: center; padding: 30px;">
                    <div class="loading" style="margin: 0 auto 10px;"></div>
                    <p>Reintentando conexi√≥n...</p>
                </td>
            `;
        }
        
        const success = await initSupabase();
        if (success) {
            if (isAdmin) {
                await loadAdminData();
            } else {
                await loadInitialData();
            }
            showError('¬°Conexi√≥n restablecida! Los datos se han cargado correctamente.');
        } else {
            if (loadingRow) {
                loadingRow.innerHTML = `
                    <td colspan="12" style="text-align: center; padding: 30px;">
                        <div style="color: var(--rojo); margin-bottom: 10px;">
                            <i class="fas fa-exclamation-triangle"></i> Error de conexi√≥n
                        </div>
                        <p>No se pudo conectar con la base de datos.</p>
                        <button class="retry-btn" onclick="retryConnection()">
                            <i class="fas fa-redo"></i> Reintentar conexi√≥n
                        </button>
                    </td>
                `;
            }
        }
    }

    // ========== INICIALIZAR SUPABASE ==========
    async function initSupabase() {
        try {
            console.log('Intentando inicializar Supabase...');
            
            // Verificar que el objeto supabase est√© disponible
            if (typeof supabase === 'undefined') {
                console.warn('Supabase no est√° disponible globalmente. Intentando carga alternativa...');
                return await loadSupabaseScript();
            }
            
            // Crear cliente de Supabase
            supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            
            // Probar conexi√≥n con timeout
            const connectionPromise = new Promise(async (resolve, reject) => {
                try {
                    const { data, error } = await supabaseClient
                        .from('eventos')
                        .select('count')
                        .limit(1)
                        .single();
                    
                    if (error) {
                        reject(error);
                    } else {
                        resolve(data);
                    }
                } catch (err) {
                    reject(err);
                }
            });
            
            // Timeout de 10 segundos
            const timeoutPromise = new Promise((_, reject) => 
                setTimeout(() => reject(new Error('Timeout: No se pudo conectar con Supabase en 10 segundos')), 10000)
            );
            
            await Promise.race([connectionPromise, timeoutPromise]);
            
            supabaseInitialized = true;
            console.log('Supabase inicializado y conectado correctamente');
            return true;
            
        } catch (error) {
            console.error('Error al inicializar Supabase:', error);
            supabaseInitialized = false;
            supabaseClient = null;
            return false;
        }
    }

    // ========== CARGAR SUPABASE DIN√ÅMICAMENTE ==========
    async function loadSupabaseScript() {
        return new Promise((resolve) => {
            console.log('Cargando Supabase din√°micamente...');
            
            
            if (typeof supabase !== 'undefined') {
                console.log('Supabase ya est√° cargado');
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                supabaseInitialized = true;
                resolve(true);
                return;
            }
            
            
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js';
            script.integrity = 'sha512-oew1/glSJ5oNs4qwfH/pzgrn9+kqHhW+lQuxYSOJ8ZnBue3hfs2oyDK1WuxwN3F07P3g1Ok/ONt0WZz0CqKAKQ==';
            script.crossOrigin = 'anonymous';
            
            script.onload = () => {
                console.log('Supabase cargado din√°micamente con √©xito');
                try {
                    supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    supabaseInitialized = true;
                    resolve(true);
                } catch (err) {
                    console.error('Error al crear cliente Supabase:', err);
                    resolve(false);
                }
            };
            
            script.onerror = () => {
                console.error('Error al cargar Supabase din√°micamente');
                supabaseInitialized = false;
                resolve(false);
            };
            
            document.head.appendChild(script);
        });
    }

    // ========== FUNCI√ìN DE INICIALIZACI√ìN ==========
    function initApplication() {
        console.log('Inicializando aplicaci√≥n completa...');
        
        // Configurar eventos de modales
        setupModalEvents();
        
        // Configurar eventos de formularios
        setupFormEvents();
        
        // Configurar eventos de filtros
        setupFilterEvents();
        
        // Configurar filtros de fechas
        setupDateFilters();
        
        // Configurar modal de texto
        setupTextModalEvents();
        
        // Inicializar sistema de correos
        initEmailSystem();
        
        console.log('Aplicaci√≥n inicializada correctamente');
    }
    
    // ========== CONFIGURAR EVENTOS DE MODALES ==========
    function setupModalEvents() {
        
        const closeLoginBtn = document.getElementById('close-login-modal');
        if (closeLoginBtn) {
            closeLoginBtn.onclick = function() {
                document.getElementById('login-modal').style.display = 'none';
                document.getElementById('login-error').style.display = 'none';
                document.getElementById('admin-password').value = '';
            };
        }
        
        // Submit login
        const loginSubmitBtn = document.getElementById('login-submit');
        if (loginSubmitBtn) {
            loginSubmitBtn.onclick = async function() {
                const password = document.getElementById('admin-password').value;
                const loginError = document.getElementById('login-error');
                
                if (password === ADMIN_PASSWORD) {
                    console.log('Acceso de administrador concedido');
                    isAdmin = true;
                    
                    // Ocultar panel p√∫blico y mostrar panel admin
                    document.getElementById('public-panel').style.display = 'none';
                    document.getElementById('admin-panel').style.display = 'block';
                    document.getElementById('login-modal').style.display = 'none';
                    loginError.style.display = 'none';
                    document.getElementById('admin-password').value = '';
                    
                    // Cargar datos en panel admin
                    await loadAdminData();
                } else {
                    console.log('Contrase√±a incorrecta');
                    loginError.style.display = 'block';
                }
            };
        }
        
        // Login con Enter
        const adminPasswordInput = document.getElementById('admin-password');
        if (adminPasswordInput) {
            adminPasswordInput.addEventListener('keyup', function(event) {
                if (event.key === 'Enter') {
                    document.getElementById('login-submit').click();
                }
            });
        }
        
        // Cerrar sesi√≥n
        const logoutBtn = document.getElementById('logout-btn');
        if (logoutBtn) {
            logoutBtn.onclick = function() {
                isAdmin = false;
                document.getElementById('admin-panel').style.display = 'none';
                document.getElementById('public-panel').style.display = 'block';
                currentFilter = 'all';
                updateFilterButtons();
                loadInitialData();
            };
        }
        
        // Cerrar modal upload
        const closeUploadBtn = document.getElementById('close-upload-modal');
        if (closeUploadBtn) {
            closeUploadBtn.onclick = function() {
                document.getElementById('upload-modal').style.display = 'none';
                document.getElementById('evidence-file').value = '';
                document.getElementById('upload-status').style.display = 'none';
                document.getElementById('upload-success').style.display = 'none';
                document.getElementById('upload-error').style.display = 'none';
            };
        }
        
        // Submit upload
        const uploadSubmitBtn = document.getElementById('upload-submit');
        if (uploadSubmitBtn) {
            uploadSubmitBtn.onclick = async function() {
                await uploadEvidence();
            };
        }
        
        // Cerrar modal evento
        const closeEventBtn = document.getElementById('close-event-modal');
        if (closeEventBtn) {
            closeEventBtn.onclick = function() {
                document.getElementById('event-modal').style.display = 'none';
                document.getElementById('save-status').style.display = 'none';
            };
        }
        
        // Cerrar modal observaci√≥n
        const closeObservacionBtn = document.getElementById('close-observacion-modal');
        if (closeObservacionBtn) {
            closeObservacionBtn.onclick = function() {
                document.getElementById('observacion-modal').style.display = 'none';
                document.getElementById('observacion-status').style.display = 'none';
            };
        }
        
        // Cerrar modales al hacer clic fuera
        window.addEventListener('click', function(event) {
            const modals = ['login-modal', 'upload-modal', 'event-modal', 'observacion-modal', 'email-alerts-modal', 'text-modal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    modal.style.display = 'none';
                    // Resetear estados
                    if (modalId === 'upload-modal') {
                        document.getElementById('upload-status').style.display = 'none';
                        document.getElementById('upload-success').style.display = 'none';
                        document.getElementById('upload-error').style.display = 'none';
                    } else if (modalId === 'email-alerts-modal') {
                        document.getElementById('email-send-status').style.display = 'none';
                        document.getElementById('email-send-status').innerHTML = '';
                    }
                }
            });
        });
    }
    
    // ========== CONFIGURAR EVENTOS DE FORMULARIOS ==========
    function setupFormEvents() {
        // Formulario de evento
        const eventForm = document.getElementById('event-form');
        if (eventForm) {
            eventForm.onsubmit = async function(e) {
                e.preventDefault();
                await saveEvent();
            };
        }
        
        // Bot√≥n agregar evento
        const addEventBtn = document.getElementById('add-event-btn');
        if (addEventBtn) {
            addEventBtn.onclick = function() {
                openEventModal();
            };
        }
        
        // Bot√≥n guardar observaci√≥n
        const saveObservacionBtn = document.getElementById('save-observacion-btn');
        if (saveObservacionBtn) {
            saveObservacionBtn.onclick = async function() {
                await saveObservacion();
            };
        }
    }
    
    // ========== CONFIGURAR EVENTOS DE FILTROS ==========
    function setupFilterEvents() {
        // Botones de filtro
        document.querySelectorAll('.filter-btn').forEach(button => {
            button.addEventListener('click', function() {
                const filter = this.getAttribute('data-filter');
                currentFilter = filter;
                updateFilterButtons();
                filterEvents();
            });
        });
        
        // Buscador p√∫blico
        const searchInput = document.getElementById('search-input');
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                filterEvents();
            });
        }
        
        // Buscador admin
        const adminSearchInput = document.getElementById('admin-search-input');
        if (adminSearchInput) {
            adminSearchInput.addEventListener('input', function() {
                filterEvents();
            });
        }
    }
    
    // ========== MODAL DE TEXTO ==========
    function setupTextModalEvents() {
        // Cerrar modal de texto
        const closeTextBtn = document.getElementById('close-text-modal');
        if (closeTextBtn) {
            closeTextBtn.onclick = function() {
                document.getElementById('text-modal').style.display = 'none';
            };
        }
    }
    
    // ==========  FILTROS DE FECHAS ==========
    function setupDateFilters() {
        // Esta funci√≥n est√° vac√≠a pero se mantiene por consistencia
        console.log('Filtros de fechas configurados');
    }
    
    // ========== FUNCIONES PRINCIPALES ==========
    
    async function loadInitialData() {
        console.log('Cargando datos iniciales...');
        
        try {
            if (!supabaseClient || !supabaseInitialized) {
                console.error('Supabase no est√° inicializado');
                const loadingRow = document.getElementById('loading-row');
                if (loadingRow) {
                    loadingRow.innerHTML = `
                        <td colspan="12" style="text-align: center; padding: 30px;">
                            <div style="color: var(--rojo); margin-bottom: 10px;">
                                <i class="fas fa-exclamation-triangle"></i> Error de conexi√≥n
                            </div>
                            <p>No se pudo conectar con la base de datos.</p>
                            <button class="retry-btn" onclick="retryConnection()">
                                <i class="fas fa-redo"></i> Reintentar conexi√≥n
                            </button>
                        </td>
                    `;
                }
                return;
            }
            
            // Mostrar loading
            const loadingRow = document.getElementById('loading-row');
            if (loadingRow) {
                loadingRow.style.display = 'table-row';
            }
            
            // Cargar desde Supabase con timeout
            const timeoutPromise = new Promise((_, reject) => 
                setTimeout(() => reject(new Error('Timeout al cargar datos')), 15000)
            );
            
            const dataPromise = supabaseClient
                .from('eventos')
                .select('*')
                .order('created_at', { ascending: false });
            
            const { data, error } = await Promise.race([dataPromise, timeoutPromise]);
            
            if (error) {
                console.error('Error al cargar datos desde Supabase:', error);
                showError('Error al cargar los eventos: ' + error.message);
                events = [];
                displayEvents('events-body', events);
                return;
            }
            
            events = data || [];
            console.log(`Cargados ${events.length} eventos desde Supabase`);
            
            // Ocultar loading
            if (loadingRow) {
                loadingRow.style.display = 'none';
            }
            
            displayEvents('events-body', events);
            
        } catch (error) {
            console.error('Error al cargar datos:', error);
            showError('Error inesperado al cargar los eventos: ' + error.message);
            events = [];
            
            const loadingRow = document.getElementById('loading-row');
            if (loadingRow) {
                loadingRow.style.display = 'none';
            }
            
            displayEvents('events-body', events);
        }
    }
    
    async function loadAdminData() {
        console.log('Cargando datos para panel admin...');
        
        try {
            if (!supabaseClient || !supabaseInitialized) {
                console.error('Supabase no est√° inicializado para panel admin');
                events = [];
                displayEvents('admin-events-body', events);
                updateStats();
                updateChart();
                return;
            }
            
            // Mostrar loading
            const adminLoadingRow = document.getElementById('admin-loading-row');
            if (adminLoadingRow) {
                adminLoadingRow.style.display = 'table-row';
            }
            
            // Cargar desde Supabase con timeout
            const timeoutPromise = new Promise((_, reject) => 
                setTimeout(() => reject(new Error('Timeout al cargar datos admin')), 15000)
            );
            
            const dataPromise = supabaseClient
                .from('eventos')
                .select('*')
                .order('created_at', { ascending: false });
            
            const { data, error } = await Promise.race([dataPromise, timeoutPromise]);
            
            if (error) {
                console.error('Error al cargar datos admin desde Supabase:', error);
                events = [];
                displayEvents('admin-events-body', events);
                updateStats();
                updateChart();
                return;
            }
            
            events = data || [];
            console.log(`Cargados ${events.length} eventos para admin`);
            
            // Ocultar loading
            if (adminLoadingRow) {
                adminLoadingRow.style.display = 'none';
            }
            
            displayEvents('admin-events-body', events);
            updateStats();
            updateChart();
            
        } catch (error) {
            console.error('Error al cargar datos admin:', error);
            events = [];
            
            const adminLoadingRow = document.getElementById('admin-loading-row');
            if (adminLoadingRow) {
                adminLoadingRow.style.display = 'none';
            }
            
            displayEvents('admin-events-body', events);
        }
    }
    
    function displayEvents(tbodyId, eventsToShow) {
        const tbody = document.getElementById(tbodyId);
        if (!tbody) return;
        
        // Obtener criterios de filtro
        const searchTerm = tbodyId === 'admin-events-body' 
            ? document.getElementById('admin-search-input')?.value.toLowerCase() || ''
            : document.getElementById('search-input')?.value.toLowerCase() || '';
        
        let filteredEvents = eventsToShow.filter(event => {
            // Aplicar filtro de estatus
            if (currentFilter !== 'all' && event.estatus !== currentFilter) {
                return false;
            }
            
            // Aplicar b√∫squeda
            if (searchTerm) {
                const searchable = [
                    event.id,
                    event.proceso || '',
                    event.area || '',
                    event.responsable || '',
                    event.descripcion_evento || '',
                    event.plan_accion || '',
                    event.observacion || ''
                ].map(s => s ? s.toString().toLowerCase() : '');
                
                if (!searchable.some(text => text.includes(searchTerm))) {
                    return false;
                }
            }
            
            return true;
        });
        
        if (filteredEvents.length === 0) {
            tbody.innerHTML = '<tr><td colspan="12" style="text-align: center; padding: 30px;">No hay eventos para mostrar con los filtros aplicados.</td></tr>';
            return;
        }
        
        let html = '';
        
        filteredEvents.forEach(event => {
            // Determinar clase de estatus
            let statusClass = event.estatus || 'en_proceso';
            let statusText = getStatusText(statusClass);
            
            // Verificar si est√° atrasado
            if (event.fecha_compromiso && statusClass !== 'cerrado') {
                const today = new Date();
                const compromisoDate = new Date(event.fecha_compromiso);
                const isOverdue = compromisoDate < today && !event.evidencia_url;
                
                if (isOverdue) {
                    statusClass = 'atrasado';
                    statusText = 'Atrasado';
                }
            }
            
            
            const isPublicView = tbodyId === 'events-body';
            
            html += `
                <tr>
                    <td><strong>${event.id}</strong></td>
                    <td>${event.proceso || ''}</td>
                    <td>${event.area || ''}</td>
                    <td><span class="status ${(event.criticidad || '').toLowerCase().replace('√≥', 'o').replace('√≠', 'i')}">${event.criticidad || ''}</span></td>
                    <td>
                        ${truncateText(event.descripcion_evento, 50)}
                        ${event.descripcion_evento && event.descripcion_evento.length > 50 ? 
                            `<button class="view-text-btn" onclick="openTextModal('${event.id}')" title="Ver descripci√≥n completa">
                                <i class="fas fa-expand-alt"></i> Ver m√°s
                            </button>` : ''}
                    </td>
                    <td>
                        ${truncateText(event.plan_accion, 50)}
                        ${event.plan_accion && event.plan_accion.length > 50 ? 
                            `<button class="view-text-btn" onclick="openTextModal('${event.id}')" title="Ver plan de acci√≥n completo">
                                <i class="fas fa-expand-alt"></i> Ver m√°s
                            </button>` : ''}
                    </td>
                    <td>${event.responsable || ''}</td>
                    <td>${formatDate(event.fecha_compromiso)}</td>
                    <td>${formatDateTime(event.ultima_actualizacion)}</td>
                    <td>
                        <div class="observacion-cell" onclick="toggleObservacion(this)" title="${event.observacion || 'Sin observaciones'}">
                            ${event.observacion ? truncateText(event.observacion, 30) : '-'}
                        </div>
                        ${event.observacion && event.observacion.length > 30 ? 
                            `<button class="view-text-btn" onclick="openTextModal('${event.id}')" title="Ver observaci√≥n completa">
                                <i class="fas fa-expand-alt"></i> Ver m√°s
                            </button>` : ''}
                    </td>
                    <td><span class="status ${statusClass}">${statusText}</span></td>
                    <td>
                        <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                            ${isPublicView && (statusClass === 'atrasado' || statusClass === 'en_proceso') && !event.evidencia_url && statusClass !== 'tbd' ? 
                                `<button class="action-btn upload-btn" onclick="openUploadModal('${event.id}')">
                                    <i class="fas fa-upload"></i> Subir
                                </button>` : ''}
                            
                            ${isPublicView && statusClass === 'tbd' ?
                                `<button class="action-btn" style="background-color: var(--gris-medio); color: var(--gris-oscuro); cursor: not-allowed;" title="No se puede subir evidencia para eventos en estatus TBD">
                                    <i class="fas fa-ban"></i> No disponible
                                </button>` : ''}
                            
                            ${event.evidencia_url ? 
                                `<button class="action-btn view-btn" onclick="viewEvidence('${event.evidencia_url}', '${event.evidencia_filename}')">
                                    <i class="fas fa-eye"></i> Ver
                                </button>` : ''}
                            
                            ${!isPublicView && event.evidencia_url ? 
                                `<button class="action-btn download-btn" onclick="downloadEvidence('${event.id}', '${event.evidencia_filename}')">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="action-btn delete-btn" onclick="deleteEvidence('${event.id}')" title="Eliminar evidencia">
                                    <i class="fas fa-trash"></i>
                                </button>` : ''}
                            
                            ${!isPublicView ? 
                                `<button class="action-btn edit-obs-btn" onclick="openObservacionModal('${event.id}')" title="Agregar/Editar observaci√≥n">
                                    <i class="fas fa-comment"></i>
                                </button>
                                <button class="action-btn" style="background-color: var(--amarillo);" onclick="editEvent('${event.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <!-- BOT√ìN DE BORRAR ELIMINADO - ADMIN NO PUEDE BORRAR EVENTOS -->
                                ` : ''}
                        </div>
                    </td>
                </tr>
            `;
        });
        
        tbody.innerHTML = html;
    }
    
    function filterEvents() {
        displayEvents('events-body', events);
        if (isAdmin) {
            displayEvents('admin-events-body', events);
            updateStats();
            updateChart();
        }
    }
    
    function getStatusText(status) {
        const statusMap = {
            'cerrado': 'Cerrado',
            'atrasado': 'Atrasado',
            'en_proceso': 'En Proceso',
            'tbd': 'TBD'
        };
        return statusMap[status] || status;
    }
    
    function formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleDateString('es-MX');
    }
    
    function formatDateTime(dateTimeString) {
        if (!dateTimeString) return '';
        const date = new Date(dateTimeString);
        return date.toLocaleDateString('es-MX') + ' ' + date.toLocaleTimeString('es-MX', {hour: '2-digit', minute:'2-digit'});
    }
    
    function truncateText(text, maxLength) {
        if (!text) return '';
        if (text.length <= maxLength) return text;
        return text.substring(0, maxLength) + '...';
    }
    
    function updateStats() {
        // Contar eventos por estatus
        const atrasados = events.filter(e => {
            const today = new Date();
            const compromisoDate = new Date(e.fecha_compromiso);
            return (compromisoDate < today && e.estatus !== 'cerrado' && !e.evidencia_url) || e.estatus === 'atrasado';
        }).length;
        
        const enProceso = events.filter(e => e.estatus === 'en_proceso').length;
        const cerrados = events.filter(e => e.estatus === 'cerrado').length;
        const tbd = events.filter(e => e.estatus === 'tbd').length;
        
        // Calcular el total
        const total = events.length;
        
        // Calcular porcentajes
        const calcularPorcentaje = (cantidad) => {
            return total > 0 ? Math.round((cantidad / total) * 100) : 0;
        };
        
        const atrasadosPercent = calcularPorcentaje(atrasados);
        const enProcesoPercent = calcularPorcentaje(enProceso);
        const cerradosPercent = calcularPorcentaje(cerrados);
        const tbdPercent = calcularPorcentaje(tbd);
        
        // Actualizar contadores
        document.getElementById('total-count').textContent = total;
        document.getElementById('atrasados-count').textContent = atrasados;
        document.getElementById('en-proceso-count').textContent = enProceso;
        document.getElementById('cerrados-count').textContent = cerrados;
        document.getElementById('tbd-count').textContent = tbd;
        
        // Actualizar porcentajes
        if (document.getElementById('atrasados-percent')) {
            document.getElementById('atrasados-percent').textContent = `${atrasadosPercent}% del total`;
            document.getElementById('en-proceso-percent').textContent = `${enProcesoPercent}% del total`;
            document.getElementById('cerrados-percent').textContent = `${cerradosPercent}% del total`;
            document.getElementById('tbd-percent').textContent = `${tbdPercent}% del total`;
        }
    }
    
   function updateChart() {
    const ctx = document.getElementById('status-chart');
    if (!ctx) return;
    
    if (chart) {
        chart.destroy();
    }
    
    const atrasados = events.filter(e => {
        const today = new Date();
        const compromisoDate = new Date(e.fecha_compromiso);
        return (compromisoDate < today && e.estatus !== 'cerrado' && !e.evidencia_url) || e.estatus === 'atrasado';
    }).length;
    
    const enProceso = events.filter(e => e.estatus === 'en_proceso').length;
    const cerrados = events.filter(e => e.estatus === 'cerrado').length;
    const tbd = events.filter(e => e.estatus === 'tbd').length;
    
    const total = atrasados + enProceso + cerrados + tbd;
    
    // Calcular porcentajes
    const calcularPorcentaje = (cantidad) => {
        return total > 0 ? ((cantidad / total) * 100).toFixed(1) : 0;
    };
    
    const atrasadosPorcentaje = calcularPorcentaje(atrasados);
    const enProcesoPorcentaje = calcularPorcentaje(enProceso);
    const cerradosPorcentaje = calcularPorcentaje(cerrados);
    const tbdPorcentaje = calcularPorcentaje(tbd);
    
    // Crear etiquetas con porcentajes
    const labels = [
        `Atrasados (${atrasadosPorcentaje}%)`, 
        `En Proceso (${enProcesoPorcentaje}%)`, 
        `Cerrados (${cerradosPorcentaje}%)`, 
        `TBD (${tbdPorcentaje}%)`
    ];
    
    chart = new Chart(ctx.getContext('2d'), {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: [atrasados, enProceso, cerrados, tbd],
                backgroundColor: [
                    'rgba(244, 67, 54, 0.8)',    // Rojo para atrasados
                    'rgba(255, 152, 0, 0.8)',     // Amarillo para en proceso
                    'rgba(76, 175, 80, 0.8)',     // Verde para cerrados
                    'rgba(33, 150, 243, 0.8)'     // Azul para TBD
                ],
                borderColor: [
                    'rgba(244, 67, 54, 1)',
                    'rgba(255, 152, 0, 1)',
                    'rgba(76, 175, 80, 1)',
                    'rgba(33, 150, 243, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true,
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                            return `${label.split(' (')[0]}: ${value} (${percentage}%)`;
                        }
                    }
                }
            },
            cutout: '60%'
        }
    });
}
        
    // ==========  GLOBALES PARA BOTONES ==========
    
    function toggleObservacion(element) {
        element.classList.toggle('expanded');
    }
    
    function openUploadModal(eventId) {
        console.log('Abrir modal para subir evidencia del evento:', eventId);
        
        // Verificar si el evento tiene estatus TBD
        const event = events.find(e => e.id === eventId);
        if (event && event.estatus === 'tbd') {
            alert('No se puede subir evidencia para eventos con estatus TBD. Contacte al administrador para cambiar el estatus.');
            return;
        }
        
        document.getElementById('event-id').value = eventId;
        document.getElementById('upload-modal').style.display = 'flex';
        document.getElementById('upload-error').style.display = 'none';
        document.getElementById('upload-success').style.display = 'none';
    }
    
    async function uploadEvidence() {
        const eventId = document.getElementById('event-id').value;
        const fileInput = document.getElementById('evidence-file');
        const uploadError = document.getElementById('upload-error');
        const uploadSuccess = document.getElementById('upload-success');
        const uploadStatus = document.getElementById('upload-status');
        
        if (!fileInput.files[0]) {
            uploadError.textContent = 'Por favor, seleccione un archivo PDF.';
            uploadError.style.display = 'block';
            return;
        }
        
        if (fileInput.files[0].type !== 'application/pdf') {
            uploadError.textContent = 'Solo se permiten archivos PDF.';
            uploadError.style.display = 'block';
            return;
        }
        
        // Validar tama√±o del archivo (m√°ximo 3MB)
        const maxSize = 3 * 1024 * 1024; // 3MB en bytes
        if (fileInput.files[0].size > maxSize) {
            uploadError.textContent = 'El archivo es demasiado grande. El tama√±o m√°ximo permitido es 3MB.';
            uploadError.style.display = 'block';
            return;
        }
        
        // Verificar que el evento no tenga estatus TBD
        const event = events.find(e => e.id === eventId);
        if (event && event.estatus === 'tbd') {
            uploadError.textContent = 'No se puede subir evidencia para eventos con estatus TBD. Contacte al administrador.';
            uploadError.style.display = 'block';
            return;
        }
        
        // Verificar que el evento tenga estatus v√°lido para subir evidencia
        if (event && !['atrasado', 'en_proceso'].includes(event.estatus)) {
            uploadError.textContent = 'Solo se puede subir evidencia para eventos en estado "Atrasado" o "En Proceso".';
            uploadError.style.display = 'block';
            return;
        }
        
        const file = fileInput.files[0];
        const fileName = `evidencia_${eventId}_${Date.now()}.pdf`;
        
        try {
            console.log(`Subiendo evidencia para evento ${eventId}:`, fileName);
            
            // Verificar conexi√≥n
            if (!supabaseClient || !supabaseInitialized) {
                throw new Error('No hay conexi√≥n con la base de datos. Por favor, reconecte.');
            }
            
            // Mostrar estado de carga
            uploadStatus.style.display = 'block';
            uploadError.style.display = 'none';
            uploadSuccess.style.display = 'none';
            
            //  Subir a Supabase Storage
            const { data: uploadData, error: uploadErrorStorage } = await supabaseClient.storage
                .from('evidencias')
                .upload(fileName, file, {
                    cacheControl: '3600',
                    upsert: false,
                    contentType: 'application/pdf'
                });
            
            if (uploadErrorStorage) {
                // Verificar si es error de bucket no existente
                if (uploadErrorStorage.message && uploadErrorStorage.message.includes('bucket')) {
                    console.error('Bucket no existe. Contacte al administrador para configurar el almacenamiento.');
                    throw new Error('El almacenamiento no est√° configurado. Contacte al administrador.');
                }
                throw uploadErrorStorage;
            }
            
            console.log('Archivo subido a Storage:', uploadData);
            
            // Obtener URL p√∫blica
            const { data: urlData } = supabaseClient.storage
                .from('evidencias')
                .getPublicUrl(fileName);
            
            console.log('URL p√∫blica obtenida:', urlData);
            
            //  Actualizar evento en la base de datos
            const { data: updateData, error: updateError } = await supabaseClient
                .from('eventos')
                .update({
                    evidencia_url: urlData.publicUrl,
                    evidencia_filename: fileName,
                    ultima_actualizacion: new Date().toISOString(),
                    // Solo actualizar estatus a "cerrado" si est√° "atrasado" o "en_proceso"
                    ...(event.estatus === 'atrasado' || event.estatus === 'en_proceso' 
                        ? { estatus: 'cerrado' } 
                        : {})
                })
                .eq('id', eventId);
            
            if (updateError) {
                console.error('Error al actualizar evento:', updateError);
                
                if (updateError.message && updateError.message.includes('row-level security')) {
                    console.warn('Error de RLS detectado. Mostrando soluci√≥n al usuario.');
                    throw new Error('Error de permisos. La evidencia se subi√≥ pero no se pudo actualizar el evento. Contacte al administrador con el nombre del archivo: ' + fileName);
                }
                throw updateError;
            }
            
            console.log('Evento actualizado en base de datos:', updateData);
            
            // Mostrar √©xito
            uploadStatus.style.display = 'none';
            uploadSuccess.style.display = 'block';
            fileInput.value = '';
            
            // Actualizar datos despu√©s de 2 segundos
            setTimeout(async () => {
                document.getElementById('upload-modal').style.display = 'none';
                await loadInitialData();
                if (isAdmin) {
                    await loadAdminData();
                }
            }, 2000);
            
        } catch (error) {
            console.error('Error completo al subir evidencia:', error);
            uploadStatus.style.display = 'none';
            
            let errorMessage = 'Error al subir la evidencia: ';
            
            if (error.message.includes('row-level security') || error.message.includes('RLS')) {
                errorMessage = 'Error de permisos. Contacte al administrador para configurar los permisos de la base de datos.';
            } else if (error.message.includes('bucket')) {
                errorMessage = 'El almacenamiento no est√° configurado. Contacte al administrador.';
            } else if (error.message.includes('size') || error.message.includes('tama√±o')) {
                errorMessage = 'El archivo excede el tama√±o m√°ximo de 3MB.';
            } else {
                errorMessage += error.message;
            }
            
            uploadError.textContent = errorMessage;
            uploadError.style.display = 'block';
        }
    }
    
    function viewEvidence(url, filename) {
        console.log('Ver evidencia:', filename);
        window.open(url, '_blank');
    }
    
    async function downloadEvidence(eventId, filename) {
        console.log('Descargar evidencia:', filename);
        
        try {
            if (!supabaseClient || !supabaseInitialized) {
                throw new Error('No hay conexi√≥n con la base de datos');
            }
            
            // Descargar desde Supabase Storage
            const { data, error } = await supabaseClient.storage
                .from('evidencias')
                .download(filename);
            
            if (error) throw error;
            
            const url = URL.createObjectURL(data);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('Evidencia descargada exitosamente.');
        } catch (error) {
            console.error('Error al descargar evidencia:', error);
            alert('Error al descargar la evidencia: ' + error.message);
        }
    }
    
    async function deleteEvidence(eventId) {
        if (!confirm('¬øEst√° seguro de que desea eliminar esta evidencia? El usuario deber√° volver a subir el archivo.')) {
            return;
        }
        
        console.log('Eliminando evidencia del evento:', eventId);
        
        try {
            const event = events.find(e => e.id === eventId);
            
            if (!event) {
                throw new Error('Evento no encontrado');
            }
            
            if (!supabaseClient || !supabaseInitialized) {
                throw new Error('No hay conexi√≥n con la base de datos');
            }
            
            // Eliminar de Supabase Storage
            if (event.evidencia_filename) {
                const { error: deleteError } = await supabaseClient.storage
                    .from('evidencias')
                    .remove([event.evidencia_filename]);
                
                if (deleteError) throw deleteError;
            }
            
            // Actualizar evento en la base de datos
            const { error: updateError } = await supabaseClient
                .from('eventos')
                .update({
                    evidencia_url: null,
                    evidencia_filename: null,
                    ultima_actualizacion: new Date().toISOString()
                })
                .eq('id', eventId);
            
            if (updateError) throw updateError;
            
            alert('Evidencia eliminada exitosamente.');
            
            // Actualizar vistas
            await loadInitialData();
            if (isAdmin) {
                await loadAdminData();
            }
            
        } catch (error) {
            console.error('Error al eliminar evidencia:', error);
            alert('Error al eliminar la evidencia: ' + error.message);
        }
    }
    
    function openEventModal(eventId = null) {
        if (eventId) {
            // Modo edici√≥n
            document.getElementById('event-modal-title').textContent = 'Editar Evento';
            const event = events.find(e => e.id === eventId);
            
            if (event) {
                document.getElementById('proceso').value = event.proceso || '';
                document.getElementById('area').value = event.area || '';
                document.getElementById('criticidad').value = event.criticidad || '';
                document.getElementById('descripcion').value = event.descripcion_evento || '';
                document.getElementById('plan_accion').value = event.plan_accion || '';
                document.getElementById('responsable').value = event.responsable || '';
                document.getElementById('fecha_compromiso').value = event.fecha_compromiso || '';
                document.getElementById('estatus').value = event.estatus || 'en_proceso';
                document.getElementById('event-id-edit').value = event.id;
            }
        } else {
            // Modo nuevo
            document.getElementById('event-modal-title').textContent = 'Nuevo evento';
            document.getElementById('event-form').reset();
            document.getElementById('event-id-edit').value = '';
            
            // Establecer fecha m√≠nima como hoy
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('fecha_compromiso').min = today;
            document.getElementById('fecha_compromiso').value = today;
            document.getElementById('estatus').value = 'en_proceso';
        }
        
        document.getElementById('event-modal').style.display = 'flex';
        document.getElementById('save-status').style.display = 'none';
    }
    
    function openObservacionModal(eventId) {
        console.log('Abrir modal para observaci√≥n del evento:', eventId);
        const event = events.find(e => e.id === eventId);
        
        if (event) {
            document.getElementById('event-id-observacion').value = event.id;
            document.getElementById('proceso-observacion').value = event.proceso || '';
            document.getElementById('observacion-text').value = event.observacion || '';
            document.getElementById('eliminar-evidencia').checked = false;
        }
        
        document.getElementById('observacion-modal').style.display = 'flex';
        document.getElementById('observacion-status').style.display = 'none';
    }
    
    async function saveObservacion() {
        const eventId = document.getElementById('event-id-observacion').value;
        const observacion = document.getElementById('observacion-text').value;
        const eliminarEvidencia = document.getElementById('eliminar-evidencia').checked;
        const observacionStatus = document.getElementById('observacion-status');
        
        try {
            observacionStatus.style.display = 'block';
            
            const updateData = {
                observacion: observacion,
                ultima_actualizacion: new Date().toISOString()
            };
            
            if (eliminarEvidencia) {
                updateData.evidencia_url = null;
                updateData.evidencia_filename = null;
                
                // Eliminar archivo f√≠sico si existe
                const event = events.find(e => e.id === eventId);
                if (event && event.evidencia_filename && supabaseClient && supabaseInitialized) {
                    await supabaseClient.storage
                        .from('evidencias')
                        .remove([event.evidencia_filename]);
                }
            }
            
            if (!supabaseClient || !supabaseInitialized) {
                throw new Error('No hay conexi√≥n con la base de datos');
            }
            
            // Actualizar en Supabase
            const { error } = await supabaseClient
                .from('eventos')
                .update(updateData)
                .eq('id', eventId);
            
            if (error) throw error;
            
            observacionStatus.style.display = 'none';
            alert('Observaci√≥n guardada exitosamente.');
            
            document.getElementById('observacion-modal').style.display = 'none';
            
            // Actualizar vistas
            await loadInitialData();
            if (isAdmin) {
                await loadAdminData();
            }
            
        } catch (error) {
            console.error('Error al guardar observaci√≥n:', error);
            observacionStatus.style.display = 'none';
            alert('Error al guardar la observaci√≥n: ' + error.message);
        }
    }
    
    async function saveEvent() {
        const eventId = document.getElementById('event-id-edit').value;
        const saveStatus = document.getElementById('save-status');
        const saveBtn = document.getElementById('save-event-btn');
        
        const eventData = {
            proceso: document.getElementById('proceso').value,
            area: document.getElementById('area').value,
            criticidad: document.getElementById('criticidad').value,
            descripcion_evento: document.getElementById('descripcion').value,
            plan_accion: document.getElementById('plan_accion').value,
            responsable: document.getElementById('responsable').value,
            fecha_compromiso: document.getElementById('fecha_compromiso').value,
            estatus: document.getElementById('estatus').value,
            ultima_actualizacion: new Date().toISOString()
        };
        
        console.log('Guardando evento:', eventId ? 'EDITAR' : 'NUEVO', eventData);
        
        try {
            // Verificar conexi√≥n
            if (!supabaseClient || !supabaseInitialized) {
                throw new Error('No hay conexi√≥n con la base de datos');
            }
            
            // Mostrar estado de carga
            saveStatus.style.display = 'block';
            saveBtn.disabled = true;
            
            if (eventId) {
                // Editar evento existente
                const { error } = await supabaseClient
                    .from('eventos')
                    .update(eventData)
                    .eq('id', eventId);
                
                if (error) throw error;
                
                saveStatus.style.display = 'none';
                saveBtn.disabled = false;
                alert('Evento actualizado exitosamente.');
            } else {
                // Crear nuevo evento
                const newId = Date.now();
                
                const newEvent = {
                    id: newId,
                    ...eventData,
                    observacion: '',
                    evidencia_url: null,
                    evidencia_filename: null,
                    created_at: new Date().toISOString()
                };
                
                const { error } = await supabaseClient
                    .from('eventos')
                    .insert([newEvent]);
                
                if (error) throw error;
                
                saveStatus.style.display = 'none';
                saveBtn.disabled = false;
                alert('Evento creado exitosamente.');
            }
            
            document.getElementById('event-modal').style.display = 'none';
            
            // Actualizar vistas
            await loadInitialData();
            if (isAdmin) {
                await loadAdminData();
            }
            
        } catch (error) {
            console.error('Error al guardar evento:', error);
            saveStatus.style.display = 'none';
            saveBtn.disabled = false;
            alert('Error al guardar el evento: ' + error.message);
        }
    }
    
    function editEvent(eventId) {
        console.log('Editar evento:', eventId);
        openEventModal(eventId);
    }
    
    // ========== FUNCI√ìN DE ELIMINAR EVENTO (COMENTADA) ==========
    /*
    async function deleteEvent(eventId) {
        if (!confirm('¬øEst√° seguro de que desea eliminar este evento? Esta acci√≥n no se puede deshacer.')) {
            return;
        }
        
        console.log('Eliminando evento:', eventId);
        
        try {
            const event = events.find(e => e.id === eventId);
            
            if (!supabaseClient || !supabaseInitialized) {
                throw new Error('No hay conexi√≥n con la base de datos');
            }
            
            // Eliminar evidencia si existe
            if (event && event.evidencia_filename) {
                await supabaseClient.storage
                    .from('evidencias')
                    .remove([event.evidencia_filename]);
            }
            
            // Eliminar evento de la base de datos
            const { error } = await supabaseClient
                .from('eventos')
                .delete()
                .eq('id', eventId);
            
            if (error) throw error;
            
            alert('Evento eliminado exitosamente.');
            
            // Actualizar vistas
            await loadInitialData();
            if (isAdmin) {
                await loadAdminData();
            }
            
        } catch (error) {
            console.error('Error al eliminar evento:', error);
            alert('Error al eliminar el evento: ' + error.message);
        }
    }
    */
    
    // ========== FUNCI√ìN PARA ABRIR MODAL CON TEXTO COMPLETO ==========
    function openTextModal(eventId) {
        console.log('Abriendo modal de texto para evento:', eventId);
        const event = events.find(e => e.id === eventId);
        
        if (!event) {
            alert('Evento no encontrado');
            return;
        }
        
        document.getElementById('text-event-id').value = event.id;
        document.getElementById('text-proceso').value = event.proceso || '';
        document.getElementById('text-descripcion').textContent = event.descripcion_evento || 'Sin descripci√≥n disponible';
        document.getElementById('text-plan-accion').textContent = event.plan_accion || 'Sin plan de acci√≥n disponible';
        document.getElementById('text-observacion').textContent = event.observacion || 'Sin observaciones disponibles';
        
        document.getElementById('text-modal').style.display = 'flex';
    }
    
    // ========== FUNCI√ìN PARA COPIAR TODO EL TEXTO ==========
    function copyAllText() {
        const eventId = document.getElementById('text-event-id').value;
        const proceso = document.getElementById('text-proceso').value;
        const descripcion = document.getElementById('text-descripcion').textContent;
        const planAccion = document.getElementById('text-plan-accion').textContent;
        const observacion = document.getElementById('text-observacion').textContent;
        
        const fullText = `EVENTO: ${eventId}
PROCESO: ${proceso}

DESCRIPCI√ìN:
${descripcion}

PLAN DE ACCI√ìN:
${planAccion}

OBSERVACIONES:
${observacion}`;
        
        // Crear un elemento textarea temporal
        const textarea = document.createElement('textarea');
        textarea.value = fullText;
        document.body.appendChild(textarea);
        textarea.select();
        
        try {
            document.execCommand('copy');
            alert('‚úÖ Texto copiado al portapapeles');
        } catch (err) {
            console.error('Error al copiar:', err);
            alert('‚ùå Error al copiar el texto');
        }
        
        document.body.removeChild(textarea);
    }
    
    function showError(message) {
        let errorDiv = document.querySelector('.error-message');
        
        if (!errorDiv) {
            errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.style.margin = '20px auto';
            errorDiv.style.maxWidth = '1400px';
            errorDiv.style.padding = '15px 20px';
            
            
            const header = document.querySelector('header');
            if (header) {
                header.parentNode.insertBefore(errorDiv, header.nextSibling);
            } else {
                document.body.insertBefore(errorDiv, document.body.firstChild);
            }
        }
        
        errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
        
        // Remover despu√©s de 10 segundos
        setTimeout(() => {
            if (errorDiv && errorDiv.parentNode) {
                errorDiv.parentNode.removeChild(errorDiv);
            }
        }, 10000);
    }
    
    // Funci√≥n auxiliar para actualizar botones de filtro
    function updateFilterButtons() {
        document.querySelectorAll('.filter-btn').forEach(button => {
            if (button.getAttribute('data-filter') === currentFilter) {
                button.classList.add('active');
            } else {
                button.classList.remove('active');
            }
        });
    }
    
    // ========== FUNCI√ìN PARA OBTENER TEXTO DEL TIPO DE ALERTA ==========
    function getAlertTypeText(type) {
        const typeMap = {
            'atrasados': 'Eventos atrasados',
            'proximos': 'Eventos pr√≥ximos',
            'ambos': 'Eventos atrasados y pr√≥ximos',
            'todos': 'Todos los eventos activos'
        };
        return typeMap[type] || type;
    }

    // ========== SISTEMA DE ENV√çO DE CORREOS ==========
    async function initEmailSystem() {
        console.log('Inicializando sistema de correos...');
        
        // Configurar eventos del modal de correos
        setupEmailEvents();
        
        // Cargar lista de destinatarios
        await loadRecipients();
    }

    function setupEmailEvents() {
        // Abrir modal de correos
        const sendEmailBtn = document.getElementById('send-email-alerts-btn');
        if (sendEmailBtn) {
            sendEmailBtn.addEventListener('click', openEmailAlertsModal);
        }
        
        // Cerrar modal de correos
        const closeEmailBtn = document.getElementById('close-email-alerts-modal');
        if (closeEmailBtn) {
            closeEmailBtn.addEventListener('click', closeEmailAlertsModal);
        }
        
        // Eventos dentro del modal de correos
        document.getElementById('email-alert-type')?.addEventListener('change', updateEmailPreview);
        document.getElementById('select-all-recipients')?.addEventListener('click', selectAllRecipients);
        document.getElementById('deselect-all-recipients')?.addEventListener('click', deselectAllRecipients);
        document.getElementById('select-responsables')?.addEventListener('click', selectResponsablesOnly);
        document.getElementById('update-preview-btn')?.addEventListener('click', updateEmailPreview);
        document.getElementById('send-email-now-btn')?.addEventListener('click', prepareAndSendEmail);
    }

    async function loadRecipients() {
        try {
            
            recipientsList = [
                { id: 1, name: "German Fueyo Arce", email: "german.fueyoarce@dhl.com", isResponsable: true },
                { id: 2, name: "Ignacio Cortez Acu√±a", email: "cortezacuna.i@pg.com", isResponsable: true },
                { id: 3, name: "Ricardo G. Abreo Ordo√±ez", email: "ricardo.a.ordonez@dhl.com", isResponsable: true },
                { id: 4, name: "Cinthya Arroyo Bravo", email: "arroyobravo.ac@pg.com", isResponsable: true },
                { id: 5, name: "Edgar Olivo G√≥mez", email: "olivogomez.em@pg.com", isResponsable: true },
                { id: 6, name: "Rogelio Garcia Soto", email: "garcia.ro.4@pg.com", isResponsable: true },
                { id: 7, name: "F√©lix Montoya Villafa√±a", email: "montoyavallarta.fe@pg.com", isResponsable: true },
                { id: 8, name: "Maria Luisa Reyes Balderas", email: "maria.reyesb@dhl.com", isResponsable: true },
                { id: 9, name: "Jorge Palacios Gonzalez", email: "palaciosgonzalez.jo@pg.com", isResponsable: true },
                { id: 10, name: "Evelin Hinojosa Fabila", email: "evelin.hinojosaf@dhl.com", isResponsable: true },
                { id: 11, name: "Claudia Giovani Guerrero Velazquez", email: "ClaudiaGiovani.Guerrerov@dhl.com", isResponsable: true },
                { id: 12, name: "Veronica Jazmin Garcia Garcia", email: "garciagarcia.vj@pg.com", isResponsable: true }
            ];
            
            console.log('Destinatarios cargados:', recipientsList.length);
            
        } catch (error) {
            console.error('Error al cargar destinatarios:', error);
            recipientsList = [];
        }
    }

    function openEmailAlertsModal() {
        console.log('Abriendo modal de alertas por correo...');
        const modal = document.getElementById('email-alerts-modal');
        if (modal) {
            modal.style.display = 'flex';
            populateRecipientsList();
            updateEmailPreview();
        }
    }

    function closeEmailAlertsModal() {
        const modal = document.getElementById('email-alerts-modal');
        if (modal) {
            modal.style.display = 'none';
            // Resetear estados
            document.getElementById('email-send-status').style.display = 'none';
            document.getElementById('email-send-status').innerHTML = '';
        }
    }

    function populateRecipientsList() {
        const container = document.getElementById('recipients-list-container');
        if (!container) return;
        
        
        if (recipientsList.length === 0) {
            container.innerHTML = `
                <div id="recipients-loading" style="text-align: center; padding: 20px;">
                    <div class="loading" style="margin: 0 auto 10px;"></div>
                    <p>Cargando destinatarios...</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        recipientsList.forEach(recipient => {
            html += `
                <div class="recipient-item" data-id="${recipient.id}">
                    <input type="checkbox" class="recipient-checkbox" id="recipient-${recipient.id}" 
                           data-email="${recipient.email}" data-name="${recipient.name}"
                           ${recipient.isResponsable ? 'checked' : ''}>
                    <div class="recipient-info">
                        <div class="recipient-name">${recipient.name}</div>
                        <div class="recipient-email">${recipient.email}</div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        
        // Agregar eventos a los checkboxes
        document.querySelectorAll('.recipient-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                updateSelectedCount();
                updateEmailPreview();
            });
        });
        
        // Agregar eventos a los items
        document.querySelectorAll('.recipient-item').forEach(item => {
            item.addEventListener('click', function(e) {
                if (!e.target.classList.contains('recipient-checkbox')) {
                    const checkbox = this.querySelector('.recipient-checkbox');
                    checkbox.checked = !checkbox.checked;
                    checkbox.dispatchEvent(new Event('change'));
                }
            });
        });
        
        updateSelectedCount();
    }

    function updateSelectedCount() {
        const checkboxes = document.querySelectorAll('.recipient-checkbox:checked');
        const countElement = document.getElementById('selected-count-number');
        if (countElement) {
            countElement.textContent = checkboxes.length;
        }
    }

    function selectAllRecipients() {
        document.querySelectorAll('.recipient-checkbox').forEach(checkbox => {
            checkbox.checked = true;
        });
        updateSelectedCount();
        updateEmailPreview();
    }

    function deselectAllRecipients() {
        document.querySelectorAll('.recipient-checkbox').forEach(checkbox => {
            checkbox.checked = false;
        });
        updateSelectedCount();
        updateEmailPreview();
    }

    function selectResponsablesOnly() {
        document.querySelectorAll('.recipient-checkbox').forEach(checkbox => {
            const item = checkbox.closest('.recipient-item');
            checkbox.checked = item ? true : false;
        });
        updateSelectedCount();
        updateEmailPreview();
    }

    function updateEmailPreview() {
        console.log('Actualizando vista previa del correo...');
        
        const alertType = document.getElementById('email-alert-type')?.value || 'ambos';
        const today = new Date();
        const threeDaysFromNow = new Date();
        threeDaysFromNow.setDate(today.getDate() + 3);
        
        // Filtrar eventos seg√∫n el tipo de alerta
        let filteredEvents = [];
        
        switch (alertType) {
            case 'atrasados':
                filteredEvents = events.filter(event => {
                    const eventDate = new Date(event.fecha_compromiso);
                    return eventDate < today && event.estatus !== 'cerrado' && !event.evidencia_url;
                });
                break;
                
            case 'proximos':
                filteredEvents = events.filter(event => {
                    const eventDate = new Date(event.fecha_compromiso);
                    return eventDate >= today && eventDate <= threeDaysFromNow && 
                           event.estatus !== 'cerrado' && !event.evidencia_url;
                });
                break;
                
            case 'ambos':
                filteredEvents = events.filter(event => {
                    const eventDate = new Date(event.fecha_compromiso);
                    const isOverdue = eventDate < today && event.estatus !== 'cerrado' && !event.evidencia_url;
                    const isUpcoming = eventDate >= today && eventDate <= threeDaysFromNow && 
                                       event.estatus !== 'cerrado' && !event.evidencia_url;
                    return isOverdue || isUpcoming;
                });
                break;
                
            case 'todos':
                filteredEvents = events.filter(event => 
                    event.estatus !== 'cerrado' && !event.evidencia_url
                );
                break;
        }
        
        // Obtener destinatarios seleccionados
        const selectedRecipients = Array.from(document.querySelectorAll('.recipient-checkbox:checked'))
            .map(cb => ({
                name: cb.getAttribute('data-name'),
                email: cb.getAttribute('data-email')
            }));
        
        // Actualizar estad√≠sticas
        const atrasadosCount = filteredEvents.filter(event => {
            const eventDate = new Date(event.fecha_compromiso);
            return eventDate < today;
        }).length;
        
        const proximosCount = filteredEvents.filter(event => {
            const eventDate = new Date(event.fecha_compromiso);
            return eventDate >= today && eventDate <= threeDaysFromNow;
        }).length;
        
        document.getElementById('stats-atrasados').textContent = atrasadosCount;
        document.getElementById('stats-proximos').textContent = proximosCount;
        document.getElementById('stats-destinatarios').textContent = selectedRecipients.length;
        
        // Generar vista previa
        const previewContainer = document.getElementById('email-preview-content');
        if (!previewContainer) return;
        
        if (filteredEvents.length === 0) {
            previewContainer.innerHTML = `
                <p style="text-align: center; color: #666; font-style: italic; padding: 20px;">
                    No hay eventos para mostrar con el filtro seleccionado.
                </p>
            `;
            return;
        }
        
        let previewHTML = `
            <p><strong>Asunto:</strong> Estatus Planes de Acci√≥n/Master Plan - ${today.toLocaleDateString('es-MX')}</p>
            <p><strong>Para:</strong> ${selectedRecipients.map(r => r.name).join(', ')}</p>
            <p><strong>Total eventos:</strong> ${filteredEvents.length} (${atrasadosCount} atrasados, ${proximosCount} pr√≥ximos)</p>
            
            <table class="email-preview-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Proceso</th>
                        <th>√Årea</th>
                        <th>Responsable</th>
                        <th>Fecha Compromiso</th>
                        <th>Estatus</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        filteredEvents.forEach(event => {
            const eventDate = new Date(event.fecha_compromiso);
            const isOverdue = eventDate < today;
            const isUpcoming = eventDate >= today && eventDate <= threeDaysFromNow;
            
            let statusBadge = '';
            if (isOverdue) {
                statusBadge = '<span class="email-badge badge-red">ATRASADO</span>';
            } else if (isUpcoming) {
                statusBadge = '<span class="email-badge badge-orange">PR√ìXIMO</span>';
            } else {
                statusBadge = '<span class="email-badge badge-green">EN PROCESO</span>';
            }
            
            previewHTML += `
                <tr>
                    <td>${event.id}</td>
                    <td>${event.proceso || ''}</td>
                    <td>${event.area || ''}</td>
                    <td>${event.responsable || ''}</td>
                    <td>${formatDate(event.fecha_compromiso)}</td>
                    <td>${statusBadge}</td>
                </tr>
            `;
        });
        
        previewHTML += `
                </tbody>
            </table>
            <p style="margin-top: 15px; font-size: 12px; color: #666;">
                <em>Este es un correo autom√°tico del Master plan .</em>
            </p>
        `;
        
        previewContainer.innerHTML = previewHTML;
    }

    function prepareAndSendEmail() {
        console.log('Preparando correo para enviar...');
        
        const alertType = document.getElementById('email-alert-type')?.value || 'ambos';
        const today = new Date();
        const threeDaysFromNow = new Date();
        threeDaysFromNow.setDate(today.getDate() + 3);
        
        // Filtrar eventos
        let filteredEvents = [];
        
        switch (alertType) {
            case 'atrasados':
                filteredEvents = events.filter(event => {
                    const eventDate = new Date(event.fecha_compromiso);
                    return eventDate < today && event.estatus !== 'cerrado' && !event.evidencia_url;
                });
                break;
                
            case 'proximos':
                filteredEvents = events.filter(event => {
                    const eventDate = new Date(event.fecha_compromiso);
                    return eventDate >= today && eventDate <= threeDaysFromNow && 
                           event.estatus !== 'cerrado' && !event.evidencia_url;
                });
                break;
                
            case 'ambos':
                filteredEvents = events.filter(event => {
                    const eventDate = new Date(event.fecha_compromiso);
                    const isOverdue = eventDate < today && event.estatus !== 'cerrado' && !event.evidencia_url;
                    const isUpcoming = eventDate >= today && eventDate <= threeDaysFromNow && 
                                       event.estatus !== 'cerrado' && !event.evidencia_url;
                    return isOverdue || isUpcoming;
                });
                break;
                
            case 'todos':
                filteredEvents = events.filter(event => 
                    event.estatus !== 'cerrado' && !event.evidencia_url
                );
                break;
        }
        
        // Obtener destinatarios seleccionados
        const selectedRecipients = Array.from(document.querySelectorAll('.recipient-checkbox:checked'))
            .map(cb => cb.getAttribute('data-email'));
        
        if (selectedRecipients.length === 0) {
            showEmailStatus('Por favor, seleccione al menos un destinatario.', 'error');
            return;
        }
        
        if (filteredEvents.length === 0) {
            showEmailStatus('No hay eventos para enviar con el filtro seleccionado.', 'warning');
            return;
        }
        
        // Calcular estad√≠sticas
        const atrasados = filteredEvents.filter(event => {
            const eventDate = new Date(event.fecha_compromiso);
            return eventDate < today;
        }).length;
        
        const proximos = filteredEvents.filter(event => {
            const eventDate = new Date(event.fecha_compromiso);
            return eventDate >= today && eventDate <= threeDaysFromNow;
        }).length;
        
        const to = selectedRecipients.join(',');
        
        // Asunto seg√∫n el tipo de alerta
        let urgency = "";
        if (alertType === 'atrasados' || (alertType === 'ambos' && atrasados > 0)) {
            urgency = "URGENTE ";
        }
        
        const subject = `Minuta sesi√≥n Master plan /${urgency}${today.toLocaleDateString('es-MX')}`;
        
        const systemUrl = window.location.origin || "https://ittsl16.github.io/Master-Plan/";
        
        // Crear cuerpo del correo en HTML
        emailHTMLContent = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte Master Plan</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background: linear-gradient(to right, #CF002E, #FDD000);
            color: white;
            padding: 20px;
            border-radius: 10px 10px 0 0;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 24px;
        }
        .content {
            background: #ffffff;
            padding: 25px;
            border: 1px solid #e0e0e0;
            border-top: none;
            border-radius: 0 0 10px 10px;
        }
        .urgency-banner {
            background-color: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .stats-box {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
        }
        .stat-item {
            text-align: center;
            margin: 10px;
        }
        .stat-number {
            font-size: 28px;
            font-weight: bold;
            color: #CF002E;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }
        .events-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .events-table th {
            background-color: #f8f9fa;
            padding: 12px;
            text-align: left;
            border-bottom: 2px solid #CF002E;
            color: #CF002E;
            font-weight: bold;
        }
        .events-table td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }
        .events-table tr:hover {
            background-color: #f9f9f9;
        }
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        .badge-atrasado {
            background-color: #f44336;
            color: white;
        }
        .badge-proximo {
            background-color: #ff9800;
            color: white;
        }
        .action-button {
            display: inline-block;
            background: linear-gradient(to right, #CF002E, #FDD000);
            color: white;
            padding: 12px 25px;
            text-decoration: none;
            border-radius: 5px;
            font-weight: bold;
            margin: 15px 0;
        }
        .footer {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
            font-size: 12px;
            color: #666;
            text-align: center;
        }
        .separator {
            border-top: 3px solid #CF002E;
            margin: 20px 0;
        }
        .emoji {
            font-size: 20px;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üö® MASTER PLAN - REPORTE DE EVENTOS</h1>
    </div>
    
    <div class="content">
        <div class="urgency-banner">
            <h2 style="margin: 0; color: #d35400;">‚ö†Ô∏è CON FIN URGENTE</h2>
        </div>
        
        <div class="separator"></div>
        
        <p><strong>Estimado equipo,</strong></p>
        <p>Se han detectado los siguientes eventos que requieren atenci√≥n inmediata:</p>
        
        <div class="stats-box">
            <div class="stat-item">
                <div class="stat-number">${filteredEvents.length}</div>
                <div class="stat-label">Total eventos</div>
            </div>
            ${atrasados > 0 ? `
            <div class="stat-item">
                <div class="stat-number">${atrasados}</div>
                <div class="stat-label">Atrasados</div>
            </div>` : ''}
            ${proximos > 0 ? `
            <div class="stat-item">
                <div class="stat-number">${proximos}</div>
                <div class="stat-label">Pr√≥ximos</div>
            </div>` : ''}
            <div class="stat-item">
                <div class="stat-number">${getAlertTypeText(alertType)}</div>
                <div class="stat-label">Tipo de reporte</div>
            </div>
        </div>
        
        <h3>üìã DETALLE DE EVENTOS</h3>
        
        <table class="events-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Estatus</th>
                    <th>ID</th>
                    <th>Proceso</th>
                    <th>√Årea</th>
                    <th>Responsable</th>
                    <th>Fecha L√≠mite</th>
                </tr>
            </thead>
            <tbody>
                ${filteredEvents.map((event, index) => {
                    const eventDate = new Date(event.fecha_compromiso);
                    const isOverdue = eventDate < today;
                    const isUpcoming = eventDate >= today && eventDate <= threeDaysFromNow;
                    
                    let badgeClass = '';
                    let badgeText = '';
                    
                    if (isOverdue) {
                        badgeClass = 'badge-atrasado';
                        badgeText = 'ATRASADO';
                    } else if (isUpcoming) {
                        badgeClass = 'badge-proximo';
                        badgeText = 'PR√ìXIMO';
                    }
                    
                    return `
                    <tr>
                        <td><strong>${index + 1}</strong></td>
                        <td><span class="badge ${badgeClass}">${badgeText}</span></td>
                        <td><code>${event.id}</code></td>
                        <td>${event.proceso || '-'}</td>
                        <td>${event.area || '-'}</td>
                        <td>${event.responsable || '-'}</td>
                        <td>${formatDate(event.fecha_compromiso)}</td>
                    </tr>
                    `;
                }).join('')}
            </tbody>
        </table>
        
        <h3>üîó ACCEDER AL SISTEMA</h3>
        <p>Revise detalles completos, descripci√≥n, plan de acci√≥n y actualice estatus en:</p>
        
        <div style="text-align: center; margin: 25px 0;">
            <a href="${systemUrl}" class="action-button" target="_blank">
                üìä IR AL MASTER PLAN
            </a>
        </div>
        
        <div class="footer">
            <p>---</p>
            <p>üìß <em>Mensaje autom√°tico generado por el Sistema Master Plan</em></p>
            <p><strong>‚ö†Ô∏è No responder a este correo</strong></p>
            <p>Master Plan Digital ¬© ${new Date().getFullYear()}</p>
        </div>
    </div>
</body>
</html>`;
        
        // Crear versi√≥n texto plano para clientes que no soportan HTML
    const textBody = `CON FIN URGENTE
==============================================================
Estimado equipo,
Se han detectado los siguientes eventos que requieren atenci√≥n:

Tipo de Reporte: ${getAlertTypeText(alertType)}
Total eventos: ${filteredEvents.length}${atrasados > 0 ? ` | Atrasados: ${atrasados}` : ''}${proximos > 0 ? ` | Pr√≥ximos: ${proximos}` : ''}

DETALLE DE EVENTOS:
===================
${filteredEvents.map((event, index) => {
    const eventDate = new Date(event.fecha_compromiso);
    const isOverdue = eventDate < today;
    const isUpcoming = eventDate >= today && eventDate <= threeDaysFromNow;
    
    let etiqueta = "";
    if (isOverdue) etiqueta = "[ATRASADO] ";
    else if (isUpcoming) etiqueta = "[PR√ìXIMO] ";
    
    return `${index + 1}. ${etiqueta}${event.id} | ${event.proceso || '-'} | ${event.area || '-'} | ${event.responsable || '-'} | ${formatDate(event.fecha_compromiso)}`;
}).join('\n')}

ACCEDER AL SISTEMA:
===================
Revise detalles completos y actualice estatus en el siguiente enlace:
${systemUrl}

---
En caso de requerir una extensi√≥n de tiempo adjuntar el justificante por este medio 
Master plan`;

        // Crear mailto link con HTML y texto plano
        const mailtoLink = `mailto:${to}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(textBody)}`;
        
        window.open(mailtoLink, '_blank');
        
        // Mostrar vista previa del correo HTML
        showEmailPreview(emailHTMLContent, selectedRecipients.length, filteredEvents.length, atrasados, proximos);
    }

    // ========== FUNCI√ìN PARA MOSTRAR VISTA PREVIA DEL CORREO HTML ==========
    function showEmailPreview(htmlContent, destinatariosCount, eventosCount, atrasadosCount, proximosCount) {
        const statusElement = document.getElementById('email-send-status');
        if (!statusElement) return;
        
        statusElement.style.display = 'block';
        statusElement.style.background = '#e8f5e9';
        statusElement.style.borderLeft = '4px solid #4CAF50';
        statusElement.innerHTML = `
            <div style="color: #4CAF50; font-size: 16px; margin-bottom: 15px;">
                <i class="fas fa-check-circle"></i> Correo preparado exitosamente
            </div>
            
            <div style="background: #f0f9ff; padding: 15px; border-radius: 5px; border-left: 4px solid #2196F3; margin-bottom: 15px;">
                <h4 style="margin-top: 0; color: #2196F3;"><i class="fas fa-chart-bar"></i> Resumen del reporte:</h4>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px;">
                    <div style="text-align: center; background: white; padding: 10px; border-radius: 5px;">
                        <div style="font-size: 22px; font-weight: bold; color: #9C27B0;">${destinatariosCount}</div>
                        <div style="font-size: 11px; color: #666;">Destinatarios</div>
                    </div>
                    <div style="text-align: center; background: white; padding: 10px; border-radius: 5px;">
                        <div style="font-size: 22px; font-weight: bold; color: #2196F3;">${eventosCount}</div>
                        <div style="font-size: 11px; color: #666;">Eventos totales</div>
                    </div>
                    ${atrasadosCount > 0 ? `
                    <div style="text-align: center; background: white; padding: 10px; border-radius: 5px;">
                        <div style="font-size: 22px; font-weight: bold; color: #f44336;">${atrasadosCount}</div>
                        <div style="font-size: 11px; color: #666;">Atrasados</div>
                    </div>` : ''}
                    ${proximosCount > 0 ? `
                    <div style="text-align: center; background: white; padding: 10px; border-radius: 5px;">
                        <div style="font-size: 22px; font-weight: bold; color: #FF9800;">${proximosCount}</div>
                        <div style="font-size: 11px; color: #666;">Pr√≥ximos</div>
                    </div>` : ''}
                </div>
            </div>
            
        
        `;
    }

    // ========== FUNCI√ìN PARA COPIAR EL HTML AL PORTAPAPELES ==========
    function copyEmailHTML() {
        const htmlContent = window.emailHTMLContent;
        if (!htmlContent) return;
        
        // Crear un elemento textarea temporal
        const textarea = document.createElement('textarea');
        textarea.value = htmlContent;
        document.body.appendChild(textarea);
        textarea.select();
        
        try {
            document.execCommand('copy');
            alert('‚úÖ HTML copiado al portapapeles. Ahora p√©guelo en el cuerpo del correo.');
        } catch (err) {
            console.error('Error al copiar:', err);
            alert('‚ùå Error al copiar al portapapeles. Intente manualmente.');
        }
        
        document.body.removeChild(textarea);
    }

    // ========== FUNCI√ìN PARA MOSTRAR ESTADO DEL CORREO ==========
    function showEmailStatus(message, type = 'info') {
        const statusElement = document.getElementById('email-send-status');
        if (!statusElement) return;
        
        let bgColor = '#e3f2fd';
        let borderColor = '#2196F3';
        
        if (type === 'error') {
            bgColor = '#ffebee';
            borderColor = '#f44336';
        } else if (type === 'warning') {
            bgColor = '#fff3e0';
            borderColor = '#FF9800';
        } else if (type === 'success') {
            bgColor = '#e8f5e9';
            borderColor = '#4CAF50';
        }
        
        statusElement.style.display = 'block';
        statusElement.style.background = bgColor;
        statusElement.style.borderLeft = `4px solid ${borderColor}`;
        statusElement.innerHTML = message;
    }

    // ========== FIN SISTEMA DE ENV√çO DE CORREOS ==========

    console.log('Sistema de Gesti√≥n de Calidad - Cargado y listo');
</script>
  
</body>
</html>


